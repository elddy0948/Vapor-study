# Today I Learned

### Controllers

Controller들은 Application의 logic을 그룹화하기에 좋은 방법이다. 대부분의 controller들은 Request를 받아 그에대한 Response를 반환해주는 많은 함수를 가지고 있다.

Controller는 기본적으로 RouteCollection이라는 프로토콜의 상속을 받는다. RouteCollection 즉 한국말로 '경로의 모음' 정도로 해석될 수 있는것 같다. 경로들을 그룹화 해주기 위한 역할로 사용할 수 있는것이다. 

```swift
struct HelloController: RouteCollection { }
```

이런식으로 선언할 수 있다. 기존의 Vapor Document를 따라서 작성했던 route.swift 파일에 있던 여러개의 경로들을 그룹화 해줄 수 있다. 예를들어서 

```swift
    app.get("hello") { req -> String in
        return "Hello, world!"
    }
    app.get("hello", ":name") { req -> String in
        return "Hello, " + req.parameters.get("name")!
    }
```

기존에 route.swift 파일에서 위와같은 2개의 경로가 있다 하나는 /hello 로 접속하면 화면에 Hello, world! 가 나올 것이고, 두번째는 /hello/joons 로 접속하면 화면에 Hello, joons가 나올 것이다. 이는 "hello"라는 공통적인 경로를 쓰고 있다. 즉 그룹화해서 나타낼 수 있다. HelloController.swift 파일에 코드를 작성해보면 

```swift
struct HelloController: RouteCollection {
    func boot(routes: RoutesBuilder) throws {
        let helloRoutes = routes.grouped("hello")
        helloRoutes.get(use: helloWorld(_:))
        helloRoutes.get(":name", use: helloName(_:))
    }
    
    func helloWorld(_ req: Request) throws -> String {
        return "Hello, world!"
    }
    func helloName(_ req: Request) throws -> String {
        return "Hello, " + req.parameters.get("name")!
    }
}

```

위에서 Controllers에 대해서 설명했던 것 처럼 Request를 받아서 그에 따른 Response를 반환해주는 수많은 함수들(helloWorld, helloName) 2개가 있고 그들을 helloRoutes라는 변수를 선언해서 겹치는 경로인 "hello" 를 그룹으로 묶어주고 있습니다. 그럼 route.swift에는 뭐가 필요한가?

```swift
func routes(_ app: Application) throws {
    let helloController = HelloController()
    try app.register(collection: helloController)
}
```

routes( : )에는 helloController라는 변수를 선언하여 HelloController를 가져오고, 그것을 register해주는 과정이 끝입니다. 

실행시켜보면 기존에 Controller를 사용하기 전과 같은 결과를 얻어오는 모습을 볼 수 있습니다. 하지만 Controller를 사용하기 전의 그 수많은 겹치는 경로와 반복되는 코드 대신에 Controller를 사용하여 좀 더 같은 경로의 Route를 그룹으로 묶어줄 수 있는 장점이 있는 것 같네요! 



[고민한 점 / 해결 방법]

Heroku-20 stack을 사용할 경우. Vapor docs에는 Swift 5.2.1버전을 사용하라고 했지만, Ubuntu 20.04에 호환하지 않는 버전이라고 에러 메시지가 나왔습니다. 이를 해결하기 위해 구글링을 해 본 결과 Swift 5.3.3버전으로 바꿔주니 해결!

```
echo "5.3.3" > .swift-version
```



Heroku를 사용하여 Postgres에 접근하려할 때 발생하는 H10에러 'App crashed' 가 계속 발생하였습니다. 이는 Vapor Discord채널을 통해서 해결하였습니다. Heroku가 Heroku Postgres에 TLS를 강제하고 있다고 하여서 

```swift
if let databaseURL = Environment.get("DATABASE_URL") {
    app.databases.use(try .postgres(
        url: databaseURL
    ), as: .psql)
} else {
    // ...
}
```

Vapor 공식문서에 있는 위 코드 대신에

```swift
if let databaseURL = Environment.get("DATABASE_URL"), var postgresConfig = PostgresConfiguration(url: databaseURL) {
    postgresConfig.tlsConfiguration = .forClient(certificateVerification: .none)
    app.databases.use(.postgres(
        configuration: postgresConfig
    ), as: .psql)
} else {
    // ...
}
```

tlsConfiguration이 들어간 코드를 사용하니 그부분의 에러는 해결되었습니다. (이젠 404 Not Found 에러가 나옴.)



